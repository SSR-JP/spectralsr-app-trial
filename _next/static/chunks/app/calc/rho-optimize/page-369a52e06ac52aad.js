(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7170],{4437:function(e,t,r){Promise.resolve().then(r.bind(r,1526))},1526:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return V}});var a=r(9241),n=r(2960),o=r(1326),i=r(4990),s=r(4161),l=r(7183),c=r(8409),d=r(49),u=r(7205),h=r(7318),p=r(7818),v=r(3098),f=r(2265),y=r(7575),m=r(5041),g=r(6463),Z=r(4326),x=r(1295),b=r(2331),S=r(4671),B=r(6548),I=r(9128);function w(e){let{loading:t,progressValue:r,progressVariant:n,children:o,sx:i,onClick:s,fullWidth:l,disabled:c}=e;return(0,a.BX)(B.Z,{variant:"contained",sx:{...i},onClick:s,disabled:t||c,fullWidth:l,children:[o,t?(0,a.tZ)(I.Z,{sx:{position:"absolute",bottom:0,left:0,right:0},variant:n,value:r}):null]})}w.defaultProps={progressVariant:"indeterminate",sx:{},fullWidth:void 0,loading:!1,progressValue:0};var C=r(149),k=r(4299),R=r(3796),_=r(4980),X=r(3460),D=r(8153),P=r(1638),T=r(3608),F=r(2420),M=r(1096),z=r(824),j=r(511),E=r(385),N=r(8784),A=r(468),H=r(6763);function O(e){let{open:t,ticketBalance:r,requiredTickets:n=1,onConfirm:i,onCancel:s,onPurchase:l,purchaseLoading:c=!1}=e,[d,u]=(0,f.useState)(!1),[p]=(0,X.fl)(),y=(0,D.PQ)(D.YI.primary.getArgb(p.scheme)),m=(0,D.PQ)(D.YI.error.getArgb(p.scheme)),g=(0,D.PQ)(D.YI.surfaceVariant.getArgb(p.scheme)),Z=r>=n,x=r-n;return(0,a.BX)(M.Z,{open:t,onClose:s,maxWidth:"sm",fullWidth:!0,sx:{"& .MuiDialog-paper":{borderRadius:3}},children:[(0,a.BX)(z.Z,{css:(0,v.iv)({display:"flex",alignItems:"center",gap:"8px",paddingBottom:"8px"}),children:[Z?(0,a.tZ)(P.Z,{css:(0,v.iv)({color:y})}):(0,a.tZ)(T.Z,{css:(0,v.iv)({color:m})}),(0,a.tZ)(j.Z,{variant:"h6",component:"span",children:Z?"チケット消費の確認":"チケットが不足しています"})]}),(0,a.tZ)(E.Z,{css:(0,v.iv)({paddingTop:"8px"}),children:Z?(0,a.BX)(a.HY,{children:[(0,a.tZ)(j.Z,{variant:"body1",css:(0,v.iv)({marginBottom:"16px"}),children:"SSR計算を開始します。以下のチケットが消費されます。"}),(0,a.BX)(o.Z,{css:(0,v.iv)({backgroundColor:g,borderRadius:"8px",padding:"16px",marginBottom:"16px"}),children:[(0,a.BX)(o.Z,{css:(0,v.iv)({display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"8px"}),children:[(0,a.tZ)(j.Z,{variant:"body2",color:"textSecondary",children:"現在のチケット残高"}),(0,a.BX)(j.Z,{variant:"body1",css:(0,v.iv)({fontWeight:"bold"}),children:[r,"枚"]})]}),(0,a.BX)(o.Z,{css:(0,v.iv)({display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"8px"}),children:[(0,a.tZ)(j.Z,{variant:"body2",color:"textSecondary",children:"消費チケット"}),(0,a.BX)(j.Z,{variant:"body1",css:(0,v.iv)({color:m}),children:["-",n,"枚"]})]}),(0,a.tZ)(h.Z,{css:(0,v.iv)({margin:"8px 0"})}),(0,a.BX)(o.Z,{css:(0,v.iv)({display:"flex",justifyContent:"space-between",alignItems:"center"}),children:[(0,a.tZ)(j.Z,{variant:"body2",color:"textSecondary",children:"計算後の残高"}),(0,a.BX)(j.Z,{variant:"body1",css:(0,v.iv)({fontWeight:"bold"}),children:[x,"枚"]})]})]})]}):(0,a.BX)(a.HY,{children:[(0,a.tZ)(j.Z,{variant:"body1",css:(0,v.iv)({marginBottom:"16px"}),children:"SSR計算を実行するにはチケットが必要です。"}),(0,a.BX)(o.Z,{css:(0,v.iv)({backgroundColor:g,borderRadius:"8px",padding:"16px",marginBottom:"16px"}),children:[(0,a.BX)(o.Z,{css:(0,v.iv)({display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"8px"}),children:[(0,a.tZ)(j.Z,{variant:"body2",color:"textSecondary",children:"現在のチケット残高"}),(0,a.BX)(j.Z,{variant:"body1",css:(0,v.iv)({color:m}),children:[r,"枚"]})]}),(0,a.BX)(o.Z,{css:(0,v.iv)({display:"flex",justifyContent:"space-between",alignItems:"center"}),children:[(0,a.tZ)(j.Z,{variant:"body2",color:"textSecondary",children:"必要なチケット"}),(0,a.BX)(j.Z,{variant:"body1",css:(0,v.iv)({fontWeight:"bold"}),children:[n,"枚"]})]})]}),(0,a.tZ)(j.Z,{variant:"body2",color:"textSecondary",children:"チケットを購入してからSSR計算を開始してください。"})]})}),(0,a.BX)(N.Z,{css:(0,v.iv)({padding:"16px 24px"}),children:[(0,a.tZ)(B.Z,{onClick:s,color:"inherit",children:"キャンセル"}),Z?(0,a.tZ)(B.Z,{onClick:i,variant:"contained",css:(0,v.iv)({backgroundColor:y}),children:"計算を開始"}):(0,a.tZ)(B.Z,{onClick:()=>u(!0),variant:"contained",startIcon:c?(0,a.tZ)(A.Z,{size:20,color:"inherit"}):(0,a.tZ)(F.Z,{}),disabled:c,css:(0,v.iv)({backgroundColor:y}),children:c?"準備中...":"チケットを購入"})]}),(0,a.tZ)(H.Z,{open:d,onPurchase:e=>{u(!1),l(e)},onCancel:()=>u(!1),purchaseLoading:c})]})}var W=r(9998),L=r(415);let G=()=>{let[e,t]=(0,f.useState)(0),[r,a]=(0,f.useState)(!1),[n]=(0,k.mN)();return{ticketBalance:e,isLoading:r,fetchTicketBalance:(0,f.useCallback)(async()=>{if(L.e.isProdTrialMode){t(999);return}if("connected"!==n.serviceStatus)return;a(!0);let e=n.apiGatewayUrl,r=n.apiClient.getAccessToken();try{let a=await fetch("".concat(e,"/tickets/balance"),{headers:{Authorization:"Bearer ".concat(r)}});if(!a.ok)throw Error("HTTP error! status: ".concat(a.status));let n=await a.json();t(Math.floor(n.ticket_balance))}catch(e){console.error("Failed to fetch ticket count:",e),(0,m.yv)("チケットの取得に失敗しました。",{variant:"error"})}finally{a(!1)}},[n.serviceStatus,n.apiGatewayUrl,n.apiClient]),updateTicketBalance:(0,f.useCallback)(e=>{t(Math.floor(e))},[])}};var K=r(6091);let Y=(0,p.default)(()=>Promise.all([r.e(5934),r.e(9109),r.e(2008)]).then(r.bind(r,2008)),{loadableGenerated:{webpack:()=>[2008]},ssr:!1});function V(){let e=(0,g.useRouter)(),[t]=(0,_.Ay)(),[r]=(0,k.mN)(),p=r.apiClient,[B,I]=(0,f.useState)(""),[X,D]=(0,f.useState)(""),[P,T]=(0,f.useState)(""),[F,M]=(0,f.useState)(0),[z,j]=(0,S.P2)(),{setActiveStep:E}=(0,b.b)(),[N,A]=(0,f.useState)(!1),[H,V]=(0,f.useState)(0),[Q,U]=(0,f.useState)([]),[J,q]=(0,f.useState)(!1),[$,ee]=(0,f.useState)("zoom"),{ticketBalance:et,fetchTicketBalance:er,updateTicketBalance:ea}=G(),[en,eo]=(0,f.useState)(!1),[ei,es]=(0,f.useState)(()=>()=>{}),{waitingForPayment:el,purchaseRunning:ec,handlePurchase:ed,handleCancelPayment:eu}=(0,K.s)({onPaymentSuccess:async()=>{await er(),(0,m.yv)("チケットの購入が完了しました",{variant:"success"}),eo(!0)},onPaymentCancel:()=>{console.log("Payment cancelled"),es(()=>()=>{})},onPaymentError:e=>{console.error("Payment error:",e),es(()=>()=>{})}}),[eh,ep]=(0,f.useState)([-6,4]),[ev,ef]=(0,f.useState)([0,4]),ey=(0,n.Z)(),em=()=>{ee("select")},eg=()=>{ee("zoom")};(0,f.useEffect)(()=>{if(E(3),"loaded"!==t.status){e.push("/");return}L.e.isProdTrialMode||er()},[t.status,er]),(0,f.useEffect)(()=>{(async()=>{try{let e=await p.serviceFetch("dataset/ssr/settings/preferred",[]);if(!e.ok){let t=await e.text();throw Error("HTTP error! status: ".concat(e.status,", ").concat(t))}let{rho_range:t}=await e.json();I(t[1]),D(t[0])}catch(e){console.error(e)}try{let e=await p.serviceFetch("dataset/rho/optimization/status",[]);if(!e.ok){let t=await e.text();throw Error("HTTP error! status: ".concat(e.status,", ").concat(t))}let{steps:t,is_done:r}=await e.json();U(t.map(e=>({iterationNumber:e.iteration_number,rho:e.rho,score:e.score})))}catch(e){console.error(e)}try{let e=await p.serviceFetch("dataset/ssr/settings/latest",[]);if(!e.ok){let t=await e.text();throw Error("HTTP error! status: ".concat(e.status,", ").concat(t))}let t=await e.json();if(!t)throw Error("No data");let{rho:r}=t;T(r)}catch(e){console.error(e)}})()},[]),(0,f.useEffect)(()=>{if(!N)return;let e=setInterval(()=>{p.serviceFetch("dataset/rho/optimization/status",[]).then(e=>e.json()).then(t=>{let{steps:r,is_done:a}=t;return U(r.map(e=>({iterationNumber:e.iteration_number,rho:e.rho,score:e.score}))),a&&(clearInterval(e),p.serviceFetch("dataset/rho/best",["range_min=".concat(X),"range_max=".concat(B)]).then(e=>e.json()).then(e=>{let{rho:t}=e;return T(t),A(!1),null}).catch(e=>{console.error(e),(0,m.yv)("".concat(e),{variant:"error"})})),null}).catch(e=>{console.error(e),(0,m.yv)("".concat(e),{variant:"error"})})},1e3);return()=>{clearInterval(e)}},[N,H]);let eZ=(0,f.useMemo)(()=>[{x:Q.map(e=>e.rho),y:Q.map(e=>e.score),type:"scatter",mode:"markers"}],[Q]),ex=async()=>{if(t.isLocked){e.push("/calc/ssr-results");return}if("number"!=typeof P){(0,m.yv)("ρの値を入力してください。",{variant:"error",persist:!0,action:R.D});return}if(L.e.isProdTrialMode){eb(P);return}let r=()=>eb(P);es(()=>r),await er(),eo(!0)},eb=async t=>{q(!0),j.setRho(t);let{optimizeIterations:r,srRange:a,srIntervalDistance:n,searchIntervalDistance:o,searchIterations:i}=z;console.log("!!!",z);try{let s=await p.serviceFetch("dataset/ssr/start",[],{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({optimize_iterations:r,sr_range:a,sr_interval_distance:n,search_interval_distance:o,search_iterations:i,rho:t})});if(!s.ok){let e=await (0,k.NZ)(s);(0,m.yv)(e,{variant:"error",action:R.D,persist:!0}),q(!1);return}e.push("/calc/ssr-results")}catch(e){console.error(e),(0,m.yv)("".concat(e),{variant:"error",action:R.D,persist:!0}),q(!1)}},eS=N||t.isLocked;return(0,a.BX)(x.T,{onNext:ex,onBack:()=>{e.push("/calc/ssr-parameter-settings")},children:[(0,a.BX)(o.Z,{sx:{display:"grid",height:{sm:"auto",md:"100%"},gridTemplateColumns:{sm:"1fr",md:"2fr 1fr"},gridTemplateRows:{sm:"1fr 1fr",md:"1fr"},gap:1},children:[(0,a.tZ)("div",{css:(0,v.iv)({display:"flex",justifyContent:"center"}),children:(0,a.tZ)(Y,{onUpdate:e=>{ep(e.layout.xaxis.range),ef(e.layout.yaxis.range)},data:eZ,layout:{width:640,height:400,dragmode:$,xaxis:{type:"log",exponentformat:"power",autorange:!1,range:eh},yaxis:{type:"log",exponentformat:"power",autorange:!1,range:ev},shapes:[{type:"rect",xref:"x",yref:"paper",x0:X,y0:0,x1:B,y1:1,line:{color:ey.palette.primary.main,width:2,dash:"dash"}}]},onSelected:e=>{D(e.range.x[0]),I(e.range.x[1])}})}),(0,a.BX)(i.Z,{sx:{p:2,overflowY:"scroll",display:"flex",flexDirection:"column"},children:[(0,a.tZ)(o.Z,{sx:{borderBottom:1,borderColor:"divider"},children:(0,a.BX)(s.Z,{value:F,onChange:(e,t)=>{M(t)},children:[(0,a.tZ)(l.Z,{label:"ρ最適化",sx:{textTransform:"none"},disabled:eS}),(0,a.tZ)(l.Z,{label:"ρ選択",sx:{textTransform:"none"},disabled:eS})]})}),(0,a.BX)(o.Z,{sx:{display:0===F?"block":"none",flexGrow:1,py:3},children:[(0,a.tZ)(c.Z,{component:"legend",sx:{display:"flex",alignItems:"center"},children:(0,a.tZ)("span",{style:{flexGrow:1},children:"最適化範囲"})}),(0,a.BX)(d.Z,{children:[(0,a.tZ)(u.Z,{disableHoverListener:!0,title:"グラフ上で範囲選択できます。",children:(0,a.tZ)(Z.Ki,{disabled:eS,label:"最小値",sx:{mt:1},value:X,onChange:e=>{D(e)},validator:(0,Z.rB)(3),onFocus:()=>em(),onBlur:()=>eg()})}),(0,a.tZ)(u.Z,{disableHoverListener:!0,title:"グラフ上で範囲選択できます。",children:(0,a.tZ)(Z.Ki,{disabled:eS,label:"最大値",sx:{mt:1},value:B,onChange:e=>{I(e)},validator:(0,Z.rB)(3),onFocus:()=>em(),onBlur:()=>eg()})})]}),(0,a.tZ)(w,{sx:{mt:3,overflow:"hidden"},fullWidth:!0,disabled:eS,loading:N,progressVariant:"determinate",progressValue:Q.length/H*100,onClick:()=>{A(!0),U([]),p.serviceFetch("dataset/rho/optimization/start",[],{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({optimize_iterations:z.optimizeIterations,sr_range:z.srRange,sr_interval_distance:z.srIntervalDistance,search_interval_distance:z.searchIntervalDistance,search_iterations:z.searchIterations,rho_range:[X,B]})}).then(e=>e.json()).then(e=>(V(e.max_iterations),null)).catch(e=>{console.error(e)}).then(()=>null).catch(e=>{console.error(e)})},children:"最適化を開始"})]}),(0,a.BX)(o.Z,{sx:{display:1===F?"block":"none",flexGrow:1,py:3},children:[(0,a.tZ)(c.Z,{component:"legend",sx:{display:"flex",alignItems:"center"},children:(0,a.tZ)("span",{style:{flexGrow:1},children:"選択範囲"})}),(0,a.BX)(d.Z,{children:[(0,a.tZ)(u.Z,{disableHoverListener:!0,title:"グラフ上で範囲選択できます。",children:(0,a.tZ)(Z.Ki,{disabled:eS,label:"最小値",sx:{mt:1},value:X,onChange:e=>{D(e)},validator:(0,Z.rB)(3),onFocus:()=>em(),onBlur:()=>eg()})}),(0,a.tZ)(u.Z,{disableHoverListener:!0,title:"グラフ上で範囲選択できます。",children:(0,a.tZ)(Z.Ki,{disabled:eS,label:"最大値",sx:{mt:1},value:B,onChange:e=>{I(e)},validator:(0,Z.rB)(3),onFocus:()=>em(),onBlur:()=>eg()})})]}),(0,a.tZ)(w,{disabled:eS,sx:{mt:3},fullWidth:!0,onClick:()=>{p.serviceFetch("dataset/rho/best",["range_min=".concat(X),"range_max=".concat(B)]).then(e=>e.json()).then(e=>{let{rho:t}=e;return T(t),null}).catch(e=>{console.error(e)})},children:"最小値を取得"})]}),(0,a.tZ)(h.Z,{sx:{mt:2}}),(0,a.tZ)(o.Z,{display:"flex",justifyContent:"center",alignItems:"center",children:(0,a.tZ)(y.Z,{color:"action",sx:{transform:"rotate(90deg)",my:2}})}),(0,a.tZ)(Z.Ki,{disabled:eS,label:"使用するρ",fullWidth:!0,value:P,onChange:e=>T(e),validator:(0,Z.rB)(3)})]})]}),(0,a.tZ)(C.f,{primaryText:"SSR実行中",open:J}),(0,a.tZ)(O,{open:en,ticketBalance:et,requiredTickets:1,onConfirm:()=>{eo(!1),ei&&(ei(),es(()=>()=>{}))},onCancel:()=>{eo(!1),es(()=>()=>{})},onPurchase:e=>{eo(!1),ed(e)},purchaseLoading:ec}),el&&(0,a.tZ)(W.Z,{onCancel:eu})]})}},4326:function(e,t,r){"use strict";r.d(t,{Ki:function(){return i},rB:function(){return o}});var a=r(9241),n=r(6858);function o(e){return t=>parseFloat(Number(t).toPrecision(e))}let i=(0,r(2265).forwardRef)(function(e,t){let{label:r,value:o,onChange:i,onBlur:s=()=>{},validator:l,disabled:c,...d}=e,u=null!=l?l:e=>parseFloat(Number(e).toFixed(3));return(0,a.tZ)(n.Z,{disabled:c,ref:t,label:r,value:"number"==typeof o?u(o):o,onChange:e=>{i(e.target.value)},onBlur:e=>{i(u(e.target.value)),null==s||s()},onKeyDown:e=>{let t=e.target;"Enter"===e.key&&i(u(t.value))},...d})})},149:function(e,t,r){"use strict";r.d(t,{f:function(){return l}});var a=r(9241),n=r(4593),o=r(1326),i=r(468),s=r(511);function l(e){let{primaryText:t,secondaryText:r,open:l}=e;return(0,a.BX)(n.Z,{sx:{color:"#fff",zIndex:e=>e.zIndex.drawer+1,display:"flex",flexDirection:"column"},open:l,style:{transitionDelay:l?"800ms":"0ms"},unmountOnExit:!0,children:[(0,a.BX)(o.Z,{sx:{display:"flex",flexDirection:"row",alignItems:"center"},children:[(0,a.tZ)(i.Z,{color:"inherit"}),(0,a.tZ)(s.Z,{variant:"h6",component:"div",sx:{ml:2},children:t})]}),(0,a.tZ)(s.Z,{variant:"h6",component:"div",children:r})]})}},4671:function(e,t,r){"use strict";r.d(t,{L7:function(){return c},P2:function(){return s}});var a=r(9241),n=r(2265);let o=(0,n.createContext)({fittingFunction:"",peakRange:[],noiseRange:[],optimizeIterations:0,srIntervalDistance:0,searchIntervalDistance:0,searchIterations:0,rho:0,rhoMax:0,rhoMin:0,searchSettingsAuto:!0,rhoSettingsAuto:!0,srRange:[0,0],originalIntervalDistance:0,plotData:[],progressIndicatorActive:!1}),i=(0,n.createContext)(()=>{}),s=()=>{let e=(0,n.useContext)(o),t=(0,n.useContext)(i);return[e,{setOptimizeIterations:e=>t({type:"setOptimizeIterations",payload:e}),setSrRange:e=>t({type:"setSrRange",payload:e}),setSrIntervalDistance:e=>t({type:"setSrIntervalDistance",payload:e}),setSearchIntervalDistance:e=>t({type:"setSearchIntervalDistance",payload:e}),setSearchIterations:e=>t({type:"setSearchIterations",payload:e}),setRhoMax:e=>t({type:"setRhoMax",payload:e}),setRhoMin:e=>t({type:"setRhoMin",payload:e}),setRho:e=>t({type:"setRho",payload:e})}]},l=(e,t)=>{switch(t.type){case"setFittingFunction":return{...e,fittingFunction:t.payload};case"setOptimizeIterations":return{...e,optimizeIterations:t.payload};case"setSrRange":return console.log("@@@ setSrRange",t.payload),{...e,srRange:t.payload};case"setSrIntervalDistance":return{...e,srIntervalDistance:t.payload};case"setSearchIntervalDistance":return{...e,searchIntervalDistance:t.payload};case"setSearchIterations":return{...e,searchIterations:t.payload};case"setRhoMax":return{...e,rhoMax:t.payload};case"setRhoMin":return{...e,rhoMin:t.payload};case"setRho":return{...e,rho:t.payload};default:throw Error("Invalid action type")}};function c(e){let{children:t}=e,[r,s]=(0,n.useReducer)(l,{fittingFunction:"",peakRange:[],noiseRange:[],optimizeIterations:0,srIntervalDistance:0,searchIntervalDistance:0,searchIterations:0,rho:0,rhoMax:0,rhoMin:0,searchSettingsAuto:!0,rhoSettingsAuto:!0,srRange:[0,0],originalIntervalDistance:0,plotData:[],progressIndicatorActive:!1});return(0,a.tZ)(o.Provider,{value:r,children:(0,a.tZ)(i.Provider,{value:s,children:t})})}}},function(e){e.O(0,[1665,9241,526,2036,819,6548,3676,4801,9009,972,5380,8273,659,5820,191,8678,8420,6156,3690,2971,7023,1744],function(){return e(e.s=4437)}),_N_E=e.O()}]);